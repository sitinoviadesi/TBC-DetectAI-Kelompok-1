<!DOCTYPE html>
<html>
<head>
    <title>Dashboard - TBC Detect AI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    
    <style>
        /* CSS DASHBOARD */
        .section-content { display: none; animation: fadeIn 0.4s ease-in-out; }
        .section-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .info-card { transition: 0.3s; border: none; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .info-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .icon-box { width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; border-radius: 50%; margin-bottom: 15px; }

        /* HERO BANNER */
        .hero-banner-tbc {
            background-image: 
                linear-gradient(to right, rgba(13, 110, 253, 1) 40%, rgba(13, 110, 253, 0.1) 100%),
                url('https://images.unsplash.com/photo-1579154204601-01588f351e67?ixlib=rb-1.2.1&auto=format&fit=crop&w=1950&q=80'); 
            background-size: cover; background-position: center; background-repeat: no-repeat;
            color: white; border: none; border-radius: 20px; position: relative; overflow: hidden;
            box-shadow: 0 10px 30px rgba(13, 110, 253, 0.2);
        }

        /* [FITUR 2] CSS LOADING OVERLAY */
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.9);
            z-index: 9999;
            display: none; /* Default sembunyi */
            justify-content: center; align-items: center; flex-direction: column;
            backdrop-filter: blur(5px);
        }
        .spinner {
            width: 60px; height: 60px;
            border: 6px solid #f3f3f3; border-top: 6px solid #0d6efd;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <div class="spinner mb-4"></div>
        <h4 class="fw-bold text-primary">Sedang Menganalisis...</h4>
        <p class="text-muted">Mohon tunggu, AI sedang memproses citra X-Ray Anda.</p>
    </div>

<div class="wrapper">
    <nav id="sidebar">
        <div class="sidebar-header">
            <h3 class="fw-bold text-primary"><i class="fas fa-lungs"></i> TBC AI</h3>
            <small class="text-muted">Medical AI System v1.0</small>
        </div>

        <ul class="list-unstyled components">
            <li><a href="#" onclick="showSection('home')" id="menu-home" class="active"><i class="fas fa-home"></i> Beranda</a></li>
            <li><a href="#" onclick="showSection('analysis')" id="menu-analysis"><i class="fas fa-microscope"></i> Analisis AI</a></li>
            <li><a href="#" onclick="showSection('history')" id="menu-history"><i class="fas fa-history"></i> Riwayat Pasien</a></li>
        </ul>

        <div class="p-4 mt-auto">
            <div class="card bg-light border-0 p-3 rounded-4">
                <div class="d-flex align-items-center">
                    <div class="bg-white rounded-circle p-2 shadow-sm me-3"><i class="fas fa-user-md text-primary"></i></div>
                    <div><p class="mb-0 fw-bold small">Dr. {{ name }}</p><p class="mb-0 text-muted small">Online</p></div>
                </div>
                <a href="/logout" class="btn btn-danger btn-sm w-100 mt-3 rounded-pill">Logout</a>
            </div>
        </div>
    </nav>

    <div id="content">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div><h2 class="fw-bold" id="page-title">Dashboard Utama</h2><p class="text-muted">Selamat datang di Sistem Pakar Deteksi TBC.</p></div>
            <button class="btn btn-white shadow-sm rounded-pill px-4"><i class="fas fa-bell text-warning"></i></button>
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show shadow-sm mb-4" role="alert">
                        {% if category == 'danger' %} <i class="fas fa-exclamation-triangle me-2"></i>
                        {% else %} <i class="fas fa-info-circle me-2"></i> {% endif %}
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <div id="section-home" class="section-content active">
            <div class="card-custom hero-banner-tbc p-5 mb-5">
                <div class="row align-items-center" style="min-height: 220px;">
                    <div class="col-lg-7 col-md-9">
                        <h1 class="display-5 fw-bold mb-3">Deteksi Dini Menyelamatkan Nyawa</h1>
                        <p class="lead mb-4" style="font-weight: 400; opacity: 0.95;">Gunakan teknologi AI untuk analisis citra X-Ray paru-paru secara instan.</p>
                        <button onclick="showSection('analysis')" class="btn btn-light text-primary fw-bold px-4 py-3 rounded-pill shadow-sm"><i class="fas fa-arrow-right me-2"></i> Mulai Diagnosis</button>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-4 mb-4"><div class="card info-card p-4 h-100"><div class="icon-box bg-danger bg-opacity-10 text-danger"><i class="fas fa-head-side-cough fa-2x"></i></div><h5 class="fw-bold">Gejala Klinis</h5><ul class="text-muted small ps-3 mb-0"><li>Batuk berdahak > 2 minggu</li><li>Nyeri dada & sesak napas</li></ul></div></div>
                <div class="col-md-4 mb-4"><div class="card info-card p-4 h-100"><div class="icon-box bg-success bg-opacity-10 text-success"><i class="fas fa-shield-virus fa-2x"></i></div><h5 class="fw-bold">Pencegahan</h5><ul class="text-muted small ps-3 mb-0"><li>Vaksinasi BCG</li><li>Gunakan masker medis</li></ul></div></div>
                <div class="col-md-4 mb-4"><div class="card info-card p-4 h-100 bg-dark text-white"><div class="icon-box bg-white text-dark"><i class="fas fa-brain fa-2x"></i></div><h5 class="fw-bold">Akurasi AI</h5><div class="d-flex align-items-end mt-2"><h2 class="fw-bold text-warning mb-0 me-2">95%</h2><small>Validasi</small></div></div></div>
            </div>
        </div>

        <div id="section-analysis" class="section-content">
            <div class="card-custom p-5">
                <div class="text-center mb-5"><div class="d-inline-block p-3 rounded-circle bg-primary bg-opacity-10 mb-3"><i class="fas fa-microscope fa-3x text-primary"></i></div><h3 class="fw-bold">Analisis Citra X-Ray</h3><p class="text-muted">Unggah citra dada untuk diagnosis otomatis.</p></div>

                <form action="/predict" method="POST" enctype="multipart/form-data">
                    <div class="row g-4 mb-4">
                        <div class="col-md-6"><label class="form-label fw-bold">Nama Pasien</label><input type="text" class="form-control form-control-lg rounded-3 bg-light border-0" name="nama" placeholder="Contoh: Tn. Budi" required></div>
                        <div class="col-md-6"><label class="form-label fw-bold">Usia</label><input type="number" class="form-control form-control-lg rounded-3 bg-light border-0" name="umur" value="30" required></div>
                    </div>
                    <div class="upload-zone mb-4">
                        <input type="file" name="file" accept=".jpg,.png,.jpeg" required onchange="previewFile(this)">
                        <div id="upload-content"><i class="fas fa-cloud-upload-alt fa-4x text-primary mb-3"></i><h5>Klik atau Tarik Gambar X-Ray Disini</h5><p class="text-muted small">Format didukung: JPG, PNG, JPEG</p></div>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mt-5">
                        <button type="button" onclick="showSection('home')" class="btn btn-outline-secondary px-4 py-2 rounded-pill">Batal</button>
                        <button type="submit" class="btn btn-primary py-3 px-5 rounded-pill fw-bold shadow-lg"><i class="fas fa-search me-2"></i> Jalankan Analisis</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="section-history" class="section-content">
            <div class="card-custom p-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h4 class="fw-bold"><i class="fas fa-history text-primary"></i> Riwayat Pemeriksaan</h4>
                    <button class="btn btn-outline-primary btn-sm rounded-pill"><i class="fas fa-print"></i> Cetak Semua</button>
                </div>

                <div class="mb-4">
                    <div class="input-group">
                        <span class="input-group-text bg-light border-0"><i class="fas fa-search text-muted"></i></span>
                        <input type="text" id="searchHistory" class="form-control bg-light border-0" placeholder="Cari nama pasien, hasil diagnosis, atau tanggal...">
                    </div>
                </div>

                {% if riwayat %}
                <div class="table-responsive">
                    <table class="table table-hover align-middle" id="historyTable">
                        <thead class="bg-light"><tr><th>Tanggal</th><th>Pasien</th><th>Usia</th><th>Hasil Diagnosa</th><th>Tingkat Risiko</th><th>Akurasi</th><th>Aksi</th></tr></thead>
                        <tbody>
                            {% for r in riwayat %}
                            <tr>
                                <td><small class="text-muted">{{ r.tanggal }}</small></td><td class="fw-bold">{{ r.nama_pasien }}</td><td>{{ r.umur }} Thn</td>
                                <td>{% if 'TBC' in r.hasil %}<span class="badge bg-danger rounded-pill px-3">TERINDIKASI TBC</span>{% else %}<span class="badge bg-success rounded-pill px-3">NORMAL</span>{% endif %}</td>
                                <td>
                                    {% if r.risk_level %}
                                        {% if 'SANGAT TINGGI' in r.risk_level %}
                                            <span class="badge bg-danger">{{ r.risk_level }}</span>
                                        {% elif 'TINGGI' in r.risk_level %}
                                            <span class="badge bg-warning">{{ r.risk_level }}</span>
                                        {% elif 'SEDANG' in r.risk_level %}
                                            <span class="badge bg-info">{{ r.risk_level }}</span>
                                        {% else %}
                                            <span class="badge bg-success">{{ r.risk_level }}</span>
                                        {% endif %}
                                    {% else %}
                                        <span class="text-muted small">-</span>
                                    {% endif %}
                                </td>
                                <td>{{ r.confidence }}</td>
                                <td><a href="/delete_history/{{ r.id }}" class="btn btn-sm btn-light text-danger" onclick="return confirm('Hapus data ini?')"><i class="fas fa-trash"></i></a></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5"><i class="fas fa-folder-open fa-4x text-muted mb-3 opacity-25"></i><h5 class="text-muted">Belum ada riwayat.</h5></div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    function showSection(sectionId) {
        document.querySelectorAll('.section-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.list-unstyled.components a').forEach(el => el.classList.remove('active'));
        document.getElementById('section-' + sectionId).classList.add('active');
        document.getElementById('menu-' + sectionId).classList.add('active');
        const titles = {'home': 'Dashboard Utama', 'analysis': 'Analisis AI', 'history': 'Data Riwayat Pasien'};
        document.getElementById('page-title').innerText = titles[sectionId];
    }

    function previewFile(input) {
        if (input.files && input.files[0]) {
            var fileName = input.files[0].name;
            document.querySelector('#upload-content h5').innerText = "File: " + fileName;
            document.querySelector('#upload-content p').innerHTML = "<span class='text-success fw-bold'>Siap Analisis</span>";
            var zone = document.querySelector('.upload-zone');
            zone.style.borderColor = "#20c997";
            zone.style.backgroundColor = "#e6fffa";
        }
    }

    // [FITUR 2] SCRIPT LOADING ANIMATION
    const analysisForm = document.querySelector('form[action="/predict"]');
    if(analysisForm){
        analysisForm.addEventListener('submit', function(){
            document.getElementById('loading-overlay').style.display = 'flex';
        });
    }

    // [FITUR 3] SCRIPT PENCARIAN RIWAYAT
    const searchInput = document.getElementById('searchHistory');
    if(searchInput) {
        searchInput.addEventListener('keyup', function() {
            let filter = this.value.toLowerCase();
            let rows = document.querySelectorAll('#historyTable tbody tr');

            rows.forEach(row => {
                let text = row.innerText.toLowerCase();
                if (text.includes(filter)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });
    }
</script>

</body>
</html>